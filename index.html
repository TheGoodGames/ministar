<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lin: Drake Clipper</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300..900&display=swap" rel="stylesheet">

<style>
:root {
    --bg:#0c0b14;
    --fg:#e8e6f6;
    --accent:#6a5acd;
}

*{margin:0;padding:0;box-sizing:border-box}

body{
    background:var(--bg);
    color:var(--fg);
    font-family:'Merriweather',serif;
    padding:20px;
}

#app{max-width:600px;margin:0 auto}

.choice-btn{
    padding:16px;
    background:var(--accent);
    color:#fff;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-size:17px;
    width:100%;
}

/* ===== DICE SCREEN ===== */
#dice-screen{
    display:none;
    text-align:center;
    padding:40px 20px;
}

.dice-area{
    display:flex;
    justify-content:center;
    gap:40px;
    perspective:800px;
    margin-bottom:30px;
}

.dice3d{
    width:80px;
    height:80px;
    position:relative;
    transform-style:preserve-3d;
    transition:transform 1.2s ease-out;
}

.dice3d.rolling{
    animation:rolling 1.2s linear infinite;
}

@keyframes rolling{
    50%{transform:rotateX(480deg) rotateY(480deg)}
}

.face{
    position:absolute;
    width:80px;
    height:80px;
    background:linear-gradient(145deg,#eee,#fff);
    border-radius:14px;
    border:4px solid #ddd;
}

.face::after{
    content:'';
    position:absolute;
    top:50%;left:50%;
    width:14px;height:14px;
    background:#111;
    border-radius:50%;
    transform:translate(-50%,-50%);
}

.front{transform:translateZ(40px)}
.back{transform:rotateX(180deg) translateZ(40px)}
.top{transform:rotateX(90deg) translateZ(40px)}
.bottom{transform:rotateX(-90deg) translateZ(40px)}
.right{transform:rotateY(90deg) translateZ(40px)}
.left{transform:rotateY(-90deg) translateZ(40px)}

.front::after{width:20px;height:20px;background:#f44336}
.back::after{box-shadow:24px 0,0 24px,24px 24px,0 48px,24px 48px}
.top::after{box-shadow:24px 24px}
.bottom::after{box-shadow:18px 18px,36px 36px,36px 0,0 36px}
.right::after{box-shadow:24px 0,0 24px,24px 24px}
.left::after{box-shadow:18px 18px,36px 36px}

.result{font-size:22px;margin:20px 0}
</style>
</head>

<body>

<div id="app">
    <div id="scene">История загружается…</div>
</div>

<div id="dice-screen"></div>

<script>
let story = {
    "0": {
        text: "Тестовый узел. Бросок кубиков.",
        choices: [
            { text: "Бросить", next: "DICE:win,mid,lose" }
        ]
    },
    "win": { text: "Успех!" },
    "mid": { text: "Частичный успех." },
    "lose": { text: "Провал." }
};

const sceneEl = document.getElementById('scene');
const diceScreen = document.getElementById('dice-screen');

function showNode(id){
    const node = story[id];
    diceScreen.style.display='none';
    sceneEl.style.display='block';

    let html = `<p style="margin-bottom:20px">${node.text}</p>`;
    if(node.choices){
        node.choices.forEach(c=>{
            html+=`<button class="choice-btn" onclick="handleChoice('${c.next}')">${c.text}</button>`;
        });
    }
    sceneEl.innerHTML = html;
}

function handleChoice(next){
    if(next.startsWith("DICE:")){
        const p = next.slice(5).split(',');
        rollDice(p[0],p[1],p[2]);
        return;
    }
    showNode(next);
}

function setDiceValue(dice,val){
    const map={
        1:'rotateX(0deg) rotateY(0deg)',
        2:'rotateX(-90deg) rotateY(0deg)',
        3:'rotateX(0deg) rotateY(90deg)',
        4:'rotateX(0deg) rotateY(-90deg)',
        5:'rotateX(90deg) rotateY(0deg)',
        6:'rotateX(180deg) rotateY(0deg)'
    };
    dice.style.transform = map[val];
}

function rollDice(success,partial,fail){
    sceneEl.style.display='none';
    diceScreen.style.display='block';

    diceScreen.innerHTML = `
        <div class="dice-area">
            <div class="dice3d" id="d1">${faces()}</div>
            <div class="dice3d" id="d2">${faces()}</div>
        </div>
        <div class="result">Бросок…</div>
        <button class="choice-btn" disabled>Бросить</button>
    `;

    const d1 = document.getElementById('d1');
    const d2 = document.getElementById('d2');
    d1.classList.add('rolling');
    d2.classList.add('rolling');

    const v1 = Math.floor(Math.random()*6)+1;
    const v2 = Math.floor(Math.random()*6)+1;

    setTimeout(()=>{
        d1.classList.remove('rolling');
        d2.classList.remove('rolling');
        setDiceValue(d1,v1);
        setDiceValue(d2,v2);

        const total = v1+v2;
        let target = total>=8?success:(total===7?partial:fail);

        diceScreen.innerHTML += `
            <div class="result">Выпало: <strong>${total}</strong></div>
            <button class="choice-btn" onclick="showNode('${target}')">Продолжить</button>
        `;
    },1300);
}

function faces(){
    return `
    <div class="face front"></div>
    <div class="face back"></div>
    <div class="face top"></div>
    <div class="face bottom"></div>
    <div class="face right"></div>
    <div class="face left"></div>`;
}

showNode("0");
</script>

</body>
</html>
