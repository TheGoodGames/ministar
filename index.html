<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lin: Drake Clipper</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0b0b12;
      --fg: #e6e6ff;
      --accent: #6a5acd;
      --success: #4caf50;
      --deadend: #f44336;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: 'Segoe UI', system-ui, sans-serif;
      padding: 20px;
      min-height: 100vh;
      overflow-x: hidden;
    }
    #app {
      max-width: 600px;
      margin: 0 auto;
    }
    #scene {
      opacity: 0;
      transform: translateY(15px);
      transition: opacity 0.45s ease, transform 0.45s ease;
      text-align: left;
    }
    #scene.active {
      opacity: 1;
      transform: translateY(0);
    }
    .illustration {
      width: 100%;
      height: 180px;
      background: rgba(30, 30, 50, 0.4);
      border-radius: 12px;
      margin: 16px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888;
      font-size: 14px;
      font-style: italic;
    }
    .text {
      font-size: 17px;
      line-height: 1.65;
      margin: 20px 0;
    }
    .text p {
      margin-bottom: 16px;
    }
    .choices {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 24px;
    }
    .choice-btn {
      padding: 15px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 11px;
      font-size: 16px;
      text-align: left;
      cursor: pointer;
      transition: background 0.2s, transform 0.12s;
    }
    .choice-btn:hover {
      background: #5a4ab0;
    }
    .choice-btn:active {
      transform: scale(0.99);
    }
    .deadend .choice-btn {
      background: var(--deadend);
    }
    .deadend .choice-btn:hover {
      background: #d32f2f;
    }
    .ending-success {
      border-left: 4px solid var(--success);
      padding-left: 12px;
    }
    .loading {
      padding: 40px;
      color: #777;
      text-align: center;
    }
    .restart-btn {
      background: #ff9800;
    }
    .restart-btn:hover {
      background: #f57c00;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="scene" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ–ª–µ–Ω–Ω–æ–π...</div>
  </div>

  <script>
    let story = null;
    let currentNodeId = null;
    const sceneEl = document.getElementById('scene');

    // –ó–∞–≥—Ä—É–∑–∫–∞ story.json
    async function loadStory() {
      try {
        const res = await fetch('story.json');
        if (!res.ok) throw new Error('–§–∞–π–ª story.json –Ω–µ –Ω–∞–π–¥–µ–Ω');
        story = await res.json();
        showNode('m1');
      } catch (e) {
        sceneEl.innerHTML = `<div class="text">–û—à–∏–±–∫–∞: ${e.message}</div>`;
      }
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞: \n\n ‚Üí <p>
    function formatText(text) {
      return text.split('\n\n').map(p => `<p>${p}</p>`).join('');
    }

    // –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –ø–æ ID (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
    function getIllustration(nodeId) {
      const scenes = {
        'm1': '–ö–æ–º–Ω–∞—Ç–∞ –õ–∏–Ω ‚Äî —Ç—É—Å–∫–ª—ã–π —Å–≤–µ—Ç, –Ω–µ–æ–Ω, –ø–æ—Ö–º–µ–ª—å–µ',
        'm2': '¬´–ì–∞—Ä–ø—É–Ω-3¬ª ‚Äî –∫–∞–±–∏–Ω–∞, –ø—Ä–∏–±–æ—Ä—ã, –∑–≤—ë–∑–¥—ã',
        'm3': '–ü–æ–ª—ë—Ç —Å–∫–≤–æ–∑—å –∞—Å—Ç–µ—Ä–æ–∏–¥—ã',
        'm4': '–ó–∞–±—Ä–æ—à–µ–Ω–Ω—ã–π –∞—É—Ç–ø–æ—Å—Ç',
        'm5': '–ë–æ–π —Å –Ω–∞—ë–º–Ω–∏–∫–∞–º–∏',
        'm6': '–ü–æ—á–∏–Ω–∫–∞ –∫–æ—Ä–∞–±–ª—è',
        'm7': '–õ—É–Ω–Ω—ã–π –ø–µ–π–∑–∞–∂, –ø—ã–ª—å, –æ—Ö—Ä–∞–Ω–∞',
        'm9': '–ù–æ—á—å –≤ –∞—É—Ç–ø–æ—Å—Ç–µ ‚Äî –±–ª–∏–∑–æ—Å—Ç—å, –¥–æ–≤–µ—Ä–∏–µ',
        'm10': '–ü—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –Ω–∞ —Ä–∞—Å—Å–≤–µ—Ç–µ',
        'success_final': 'üèÜ Drake Clipper ‚Äî –Ω–∞–π–¥–µ–Ω!',
        'a1_1': '–ë–∞—Ä ¬´–û—Ä–±–∏—Ç—É–∞—Ä–∏¬ª ‚Äî —Ç–µ–Ω–∏, —Ü–∏–ª–∏–Ω–¥—Ä',
        'a1_3': '–õ–æ—Ä–≤–∏–ª—å ‚Äî –º–µ–≥–∞–ø–æ–ª–∏—Å, —Ç—Ä—É–ø –≤ –º–∞–≥–∞–∑–∏–Ω–µ',
        'a1_5': '–ü–∞–π—Ä–æ IV ‚Äî –±—É—Ä—è, –æ—Ö–æ—Ç–Ω–∏–∫–∏',
        'a1_6': 'Sel_Oin ‚Äî –∫–ª–∏–Ω–æ–∫, –ø–ª–∞—â –∏–∑ –∫–µ–≤–ª–∞—Ä–∞'
      };
      const desc = scenes[nodeId] || 'üåå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –º–µ—Å—Ç–æ';
      return `<div class="illustration">${desc}</div>`;
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∑–ª–∞
    function showNode(nodeId) {
      if (!story[nodeId]) {
        sceneEl.innerHTML = `<div class="text">–û—à–∏–±–∫–∞: —É–∑–µ–ª "${nodeId}" –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>`;
        return;
      }

      const node = story[nodeId];
      currentNodeId = nodeId;

      const isEnding = node.ending === "true";
      const isDeadend = nodeId.startsWith('alt_') && node.choices?.some(c => c.next?.startsWith('m'));
      const className = isEnding ? 'ending-success' : isDeadend ? 'deadend' : '';

      const illustration = getIllustration(nodeId);
      const formattedText = formatText(node.text);

      const choicesHtml = node.choices?.map(c => {
        const isRestart = c.next === 'm1' || nodeId.includes('alt_') && c.next.startsWith('m');
        const btnClass = isRestart ? 'choice-btn restart-btn' : 'choice-btn';
        return `<button class="${btnClass}" onclick="handleChoice('${c.next}')">${c.text}</button>`;
      }).join('') || '';

      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
      sceneEl.classList.remove('active');
      setTimeout(() => {
        sceneEl.className = `scene ${className}`;
        sceneEl.innerHTML = `${illustration}<div class="text">${formattedText}</div><div class="choices">${choicesHtml}</div>`;
        sceneEl.classList.add('active');
      }, 320);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
    window.handleChoice = function(nextId) {
      if (nextId === 'end_game') {
        Telegram.WebApp.sendData(JSON.stringify({ result: 'aborted' }));
        Telegram.WebApp.close();
        return;
      }

      const nextNode = story[nextId];
      if (!nextNode) {
        showNode('m1');
        return;
      }

      showNode(nextId);

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–∏ –ø–æ–±–µ–¥–µ
      if (nextNode.ending === "true") {
        Telegram.WebApp.sendData(JSON.stringify({ result: 'success' }));
        Telegram.WebApp.showAlert("üèÜ –í—ã –Ω–∞—à–ª–∏ Drake Clipper!");
      }
    };

    // Telegram WebApp
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    Telegram.WebApp.MainButton.setText('–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ');
    Telegram.WebApp.MainButton.show();
    Telegram.WebApp.MainButton.onClick(() => showNode('m1'));

    // –ó–∞–ø—É—Å–∫
    loadStory();
  </script>
</body>
</html>
