<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–û–õ–ù–ê–Ø RPG –ö–í–ï–°–¢–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        #game-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(20, 20, 40, 0.95);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }

        h1 {
            text-align: center;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 20px;
            font-size: 2em;
        }

        /* –°–¢–ê–¢–´ –ü–ï–†–°–û–ù–ê–ñ–ê */
        #player-stats {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-item {
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        .stat-label {
            color: #888;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        .stat-value.health { color: #ff4444; }
        .stat-value.stamina { color: #44ff44; }
        .stat-value.money { color: #ffaa00; }

        .stat-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .stat-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .stat-bar-fill.health { background: linear-gradient(90deg, #ff4444, #ff8844); }
        .stat-bar-fill.stamina { background: linear-gradient(90deg, #44ff44, #88ff44); }

        #story-text {
            background: rgba(0, 0, 0, 0.5);
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #00ffff;
            min-height: 150px;
            line-height: 1.8;
            font-size: 1.1em;
            border-radius: 5px;
        }

        #choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .choice-button {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: 2px solid #00ffff;
            padding: 15px 25px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: inherit;
            text-align: left;
            display: block;
            position: relative;
        }

        .choice-cost {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 170, 0, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .choice-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #2a5298 0%, #3d6bb5 100%);
            transform: translateX(10px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .choice-button:disabled {
            background: #333;
            color: #666;
            border-color: #555;
            cursor: not-allowed;
            transform: none;
        }

        .choice-hidden {
            display: none !important;
        }

        /* –ò–ù–í–ï–ù–¢–ê–†–¨ */
        #inventory {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 15px;
            min-width: 280px;
            max-width: 350px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        #inventory h3 {
            color: #00ff00;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 8px;
        }

        .inventory-section {
            margin: 15px 0;
        }

        .inventory-section-title {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .key-item {
            background: rgba(0, 255, 0, 0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #00ff00;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-quantity {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .key-item.quest-type {
            border-left-color: #ffaa00;
            background: rgba(255, 170, 0, 0.1);
        }

        .key-item.item-type {
            border-left-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }

        .key-item.state-type {
            border-left-color: #00ffff;
            background: rgba(0, 255, 255, 0.1);
        }

        .key-item.key-type {
            border-left-color: #ff00ff;
            background: rgba(255, 0, 255, 0.1);
        }

        .key-animation {
            animation: keyAppear 0.5s ease;
        }

        @keyframes keyAppear {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        #password-modal, #dice-modal, #map-modal, #shop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1a2e;
            padding: 40px;
            border-radius: 15px;
            border: 2px solid #00ffff;
            text-align: center;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.5);
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .shop-item:hover {
            border-color: #00ffff;
            background: rgba(0, 255, 255, 0.1);
        }

        .shop-item-info {
            text-align: left;
            flex: 1;
        }

        .shop-item-name {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .shop-item-price {
            color: #ffaa00;
            font-size: 0.9em;
        }

        .shop-buy-btn {
            background: linear-gradient(135deg, #44ff44, #22aa22);
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .shop-buy-btn:hover {
            transform: scale(1.05);
        }

        .shop-buy-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        #password-input {
            width: 100%;
            padding: 15px;
            font-size: 1.5em;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ffff;
            color: #00ffff;
            border-radius: 8px;
            margin: 20px 0;
            letter-spacing: 10px;
        }

        .modal-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 8px;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .modal-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #dice-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .dice {
            width: 80px;
            height: 80px;
            background: white;
            border: 3px solid #333;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: #333;
            font-weight: bold;
        }

        #map-button, #shop-button {
            position: fixed;
            bottom: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }

        #map-button {
            right: 20px;
        }

        #shop-button {
            right: 180px;
            background: linear-gradient(135deg, #ffaa00, #ff8800);
        }

        #map-button:hover, #shop-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        #debug-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            #inventory {
                position: static;
                margin: 20px auto;
                max-width: 100%;
            }

            #map-button, #shop-button {
                position: static;
                width: 100%;
                margin: 10px 0;
            }

            #debug-panel {
                position: static;
                margin: 10px auto;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>üöÄ –ü–û–õ–ù–ê–Ø RPG –°–ò–°–¢–ï–ú–ê</h1>

        <!-- –°–¢–ê–¢–´ –ü–ï–†–°–û–ù–ê–ñ–ê -->
        <div id="player-stats">
            <div class="stat-item">
                <div class="stat-label">‚ù§Ô∏è –ó–î–û–†–û–í–¨–ï</div>
                <div class="stat-value health" id="health-value">100/100</div>
                <div class="stat-bar">
                    <div class="stat-bar-fill health" id="health-bar" style="width: 100%"></div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">‚ö° –≠–ù–ï–†–ì–ò–Ø</div>
                <div class="stat-value stamina" id="stamina-value">100/100</div>
                <div class="stat-bar">
                    <div class="stat-bar-fill stamina" id="stamina-bar" style="width: 100%"></div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">üí∞ –ö–†–ï–î–ò–¢–´</div>
                <div class="stat-value money" id="money-value">100</div>
            </div>
        </div>

        <div id="story-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
        <div id="choices"></div>
    </div>

    <div id="inventory">
        <h3>üì¶ –ò–ù–í–ï–ù–¢–ê–†–¨</h3>

        <div class="inventory-section">
            <div class="inventory-section-title">üéØ –ö–≤–µ—Å—Ç—ã</div>
            <div id="quests-list"></div>
        </div>

        <div class="inventory-section">
            <div class="inventory-section-title">üì¶ –ü—Ä–µ–¥–º–µ—Ç—ã</div>
            <div id="items-list"></div>
        </div>

        <div class="inventory-section">
            <div class="inventory-section-title">üîë –ö–ª—é—á–∏</div>
            <div id="keys-list"></div>
        </div>
    </div>

    <button id="shop-button">üè™ –ú–∞–≥–∞–∑–∏–Ω</button>
    <button id="map-button">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
    <div id="debug-panel" onclick="resetGame()">üîÑ –°–ë–†–û–°</div>

    <!-- Password Modal -->
    <div id="password-modal">
        <div class="modal-content">
            <h2>üîê –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥</h2>
            <input type="text" id="password-input" maxlength="10" placeholder="****">
            <p style="color: #888; font-size: 0.9em;">–ö–æ–¥ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 4 —Ü–∏—Ñ—Ä</p>
            <button class="modal-button" onclick="submitPassword()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button class="modal-button" onclick="closePasswordModal()">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <!-- Dice Modal -->
    <div id="dice-modal">
        <div class="modal-content">
            <h2>üé≤ üé≤</h2>
            <p>–ë—Ä–æ—Å—å—Ç–µ –∫–æ—Å—Ç–∏, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Å—Ö–æ–¥.</p>
            <div id="dice-container">
                <div class="dice" id="dice1">?</div>
                <div class="dice" id="dice2">?</div>
            </div>
            <div id="dice-result" style="margin: 20px 0; font-size: 1.2em; color: #00ffff;"></div>
            <button class="modal-button" onclick="rollDice()">–ë—Ä–æ—Å–∏—Ç—å –∫–æ—Å—Ç–∏</button>
            <button class="modal-button" id="dice-continue-btn" style="display: none;" onclick="continueDiceStory()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="map-modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –º–∏—Ä–∞</h2>
            <div id="map-locations" style="text-align: left; margin: 20px 0;"></div>
            <button class="modal-button" onclick="closeMap()">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shop-modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>üè™ –ú–ê–ì–ê–ó–ò–ù</h2>
            <p style="color: #ffaa00; margin: 10px 0;">üí∞ –í–∞—à–∏ –∫—Ä–µ–¥–∏—Ç—ã: <span id="shop-money">100</span></p>
            <div id="shop-items"></div>
            <button class="modal-button" onclick="closeShop()">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        // ============= –î–ê–ù–ù–´–ï –ò–°–¢–û–†–ò–ò =============
        const story = {
            "start": {
                "text": "–í—ã –ø—Ä–æ—Å—ã–ø–∞–µ—Ç–µ—Å—å –≤ –∫–∞–ø—Å—É–ª–µ —Å–ø–∞—Å–µ–Ω–∏—è. –ö–æ—Ä–∞–±–ª—å –ø–æ–≤—Ä–µ–∂–¥—ë–Ω. –ù–∞ —ç–∫—Ä–∞–Ω–µ –º–∏–≥–∞–µ—Ç —Å–∏–≥–Ω–∞–ª SOS.",
                "choices": [
                    {
                        "text": "–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∫–∞–ø—Å—É–ª—É",
                        "next": "explore_pod"
                    },
                    {
                        "text": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—ã –∫–æ—Ä–∞–±–ª—è",
                        "next": "check_ship"
                    },
                    {
                        "text": "–û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω (—Ç–µ—Å—Ç)",
                        "action": "open_shop"
                    }
                ]
            },
            "explore_pod": {
                "text": "–í –∫–∞–ø—Å—É–ª–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ –∞–≤–∞—Ä–∏–π–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç: –º–µ–¥–ø–∞–∫, –∞–ø—Ç–µ—á–∫—É –∏ 50 –∫—Ä–µ–¥–∏—Ç–æ–≤!",
                "choices": [
                    {
                        "text": "–í–∑—è—Ç—å –º–µ–¥–ø–∞–∫ x3",
                        "next": "got_medkit",
                        "collect": {
                            "id": "item_medkit",
                            "label": "üíä –ú–µ–¥–ø–∞–∫",
                            "type": "item",
                            "quantity": 3
                        }
                    },
                    {
                        "text": "–í–∑—è—Ç—å –∫–ª—é—á-–∫–∞—Ä—Ç—É",
                        "next": "got_keycard",
                        "collect": {
                            "id": "key_keycard",
                            "label": "üîë –ö–ª—é—á-–∫–∞—Ä—Ç–∞",
                            "type": "key",
                            "quantity": 1
                        }
                    },
                    {
                        "text": "–í–∑—è—Ç—å –∫—Ä–µ–¥–∏—Ç—ã (+50‚Ç°)",
                        "next": "start",
                        "money": 50
                    }
                ]
            },
            "got_medkit": {
                "text": "–ú–µ–¥–ø–∞–∫–∏ –≤ –≤–∞—à–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ. –í—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ —Å–µ–±—è —É–≤–µ—Ä–µ–Ω–Ω–µ–µ.",
                "choices": [
                    {
                        "text": "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ–¥–ø–∞–∫ (-1, +50 HP)",
                        "next": "used_medkit",
                        "requires": ["item_medkit"],
                        "consume": {
                            "id": "item_medkit",
                            "quantity": 1
                        },
                        "health": 50
                    },
                    {
                        "text": "–ò–¥—Ç–∏ –≤ –º–µ–¥–±–∞–π",
                        "next": "medbay"
                    },
                    {
                        "text": "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞–ø—Å—É–ª–µ",
                        "next": "explore_pod"
                    }
                ]
            },
            "used_medkit": {
                "text": "–í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –º–µ–¥–ø–∞–∫. –ó–¥–æ—Ä–æ–≤—å–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!",
                "choices": [
                    {
                        "text": "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
                        "next": "got_medkit"
                    }
                ]
            },
            "got_keycard": {
                "text": "–ö–ª—é—á-–∫–∞—Ä—Ç–∞ –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –∑–∞–ø–µ—Ä—Ç—ã–µ –¥–≤–µ—Ä–∏.",
                "choices": [
                    {
                        "text": "–ò–¥—Ç–∏ –≤ –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π –æ—Ç—Å–µ–∫",
                        "next": "engineering",
                        "requires": ["key_keycard"]
                    },
                    {
                        "text": "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞–ø—Å—É–ª–µ",
                        "next": "explore_pod"
                    }
                ]
            },
            "check_ship": {
                "text": "–°–∏—Å—Ç–µ–º—ã –∫–æ—Ä–∞–±–ª—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∫–∏—Å–ª–æ—Ä–æ–¥–∞. –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –∫–∞–ø–∏—Ç–∞–Ω–∞.",
                "choices": [
                    {
                        "text": "–ò—Å–∫–∞—Ç—å –∫–∞–ø–∏—Ç–∞–Ω–∞ –Ω–∞ –º–æ—Å—Ç–∏–∫–µ",
                        "next": "bridge"
                    },
                    {
                        "text": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—é—Ç—ã —ç–∫–∏–ø–∞–∂–∞",
                        "next": "crew_quarters"
                    }
                ]
            },
            "medbay": {
                "text": "–ú–µ–¥–±–∞–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑—Ä—É—à–µ–Ω. –°—Ä–µ–¥–∏ –æ–±–ª–æ–º–∫–æ–≤ –≤—ã –∑–∞–º–µ—á–∞–µ—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª.",
                "choices": [
                    {
                        "text": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª",
                        "next": "terminal_medbay",
                        "requires": ["item_medkit"],
                        "hide_until_unlocked": false,
                        "missing_messages": {
                            "item_medkit": "‚ùå –ù—É–∂–µ–Ω –º–µ–¥–ø–∞–∫ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞"
                        }
                    },
                    {
                        "text": "–í–∑–ª–æ–º–∞—Ç—å –∑–∞ 30 —ç–Ω–µ—Ä–≥–∏–∏",
                        "next": "terminal_medbay",
                        "stamina": -30
                    },
                    {
                        "text": "–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥",
                        "next": "start"
                    }
                ]
            },
            "terminal_medbay": {
                "text": "–¢–µ—Ä–º–∏–Ω–∞–ª –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–∞—Ä–æ–ª—å. –ü–æ–¥—Å–∫–∞–∑–∫–∞: '1234'.",
                "password": {
                    "correct": "1234",
                    "success": "password_success",
                    "fail": "password_fail"
                }
            },
            "password_success": {
                "text": "‚úÖ –ü–∞—Ä–æ–ª—å –ø—Ä–∏–Ω—è—Ç! –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.",
                "choices": [
                    {
                        "text": "–ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É (100‚Ç° –∏ –∫–≤–µ—Å—Ç)",
                        "next": "start",
                        "money": 100,
                        "collect": {
                            "id": "quest_save_ship",
                            "label": "üéØ –°–ø–∞—Å—Ç–∏ –∫–æ—Ä–∞–±–ª—å",
                            "type": "quest"
                        }
                    }
                ]
            },
            "password_fail": {
                "text": "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å! –¢–µ—Ä–º–∏–Ω–∞–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.",
                "choices": [
                    {
                        "text": "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞",
                        "next": "terminal_medbay"
                    },
                    {
                        "text": "–í–µ—Ä–Ω—É—Ç—å—Å—è",
                        "next": "medbay"
                    }
                ]
            },
            "bridge": {
                "text": "–ù–∞ –º–æ—Å—Ç–∏–∫–µ –≤—ã –≤—Å—Ç—Ä–µ—á–∞–µ—Ç–µ –∫–∞–ø–∏—Ç–∞–Ω–∞ –°—Ç–æ—É–Ω–∞. –û–Ω —Ä–∞–Ω–µ–Ω.",
                "choices": [
                    {
                        "text": "–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è –∫–∞–ø–∏—Ç–∞–Ω—É",
                        "next": "meet_captain",
                        "requires": ["state_met_captain"],
                        "hide_until_unlocked": false,
                        "collect": {
                            "id": "state_met_captain",
                            "label": "",
                            "type": "state"
                        },
                        "missing_messages": {
                            "state_met_captain": "–í—ã —É–∂–µ –∑–Ω–∞–∫–æ–º—ã!"
                        }
                    },
                    {
                        "text": "–ü—Ä–∏–≤–µ—Ç —Å–Ω–æ–≤–∞, –∫–∞–ø–∏—Ç–∞–Ω!",
                        "next": "captain_return",
                        "requires": ["state_met_captain"],
                        "hide_until_unlocked": true
                    },
                    {
                        "text": "–í—ã–ª–µ—á–∏—Ç—å –∫–∞–ø–∏—Ç–∞–Ω–∞ (–º–µ–¥–ø–∞–∫)",
                        "next": "heal_captain",
                        "requires": ["item_medkit", "state_met_captain"],
                        "hide_until_unlocked": true,
                        "consume": {
                            "id": "item_medkit",
                            "quantity": 1
                        }
                    }
                ]
            },
            "meet_captain": {
                "text": "–ö–∞–ø–∏—Ç–∞–Ω: '–ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ! –ü–æ–º–æ–≥–∏ –º–Ω–µ —Å–ø–∞—Å—Ç–∏ –∫–æ—Ä–∞–±–ª—å!'",
                "choices": [
                    {
                        "text": "–ü—Ä–∏–Ω—è—Ç—å –∫–≤–µ—Å—Ç",
                        "next": "start",
                        "collect": {
                            "id": "quest_help_captain",
                            "label": "üéØ –ü–æ–º–æ—á—å –∫–∞–ø–∏—Ç–∞–Ω—É",
                            "type": "quest"
                        },
                        "money": 200
                    }
                ]
            },
            "captain_return": {
                "text": "–ö–∞–ø–∏—Ç–∞–Ω: '–ö–∞–∫ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è —Ä–µ–º–æ–Ω—Ç?'",
                "choices": [
                    {
                        "text": "–ï—â—ë —Ä–∞–±–æ—Ç–∞—é",
                        "next": "start"
                    }
                ]
            },
            "heal_captain": {
                "text": "–í—ã –ª–µ—á–∏—Ç–µ –∫–∞–ø–∏—Ç–∞–Ω–∞. –û–Ω –ø–µ—Ä–µ–¥–∞—ë—Ç –≤–∞–º –≥–ª–∞–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø –∏ 500 –∫—Ä–µ–¥–∏—Ç–æ–≤!",
                "choices": [
                    {
                        "text": "–ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É",
                        "next": "start",
                        "collect": {
                            "id": "key_master_access",
                            "label": "üîê –ì–ª–∞–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø",
                            "type": "key"
                        },
                        "money": 500
                    }
                ]
            },
            "engineering": {
                "text": "–ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π –æ—Ç—Å–µ–∫. –†–µ–∞–∫—Ç–æ—Ä –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ —Ä–µ–º–æ–Ω—Ç–µ!",
                "choices": [
                    {
                        "text": "–†–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å (-50‚Ç°, –±—Ä–æ—Å–æ–∫ –∫–æ—Å—Ç–µ–π)",
                        "next": "reactor_dice",
                        "cost": 50
                    },
                    {
                        "text": "–ù–∞–∑–∞–¥",
                        "next": "start"
                    }
                ]
            },
            "reactor_dice": {
                "text": "–í—ã –Ω–∞—á–∏–Ω–∞–µ—Ç–µ —Ä–µ–º–æ–Ω—Ç —Ä–µ–∞–∫—Ç–æ—Ä–∞. –ë—Ä–æ—Å—å—Ç–µ –∫–æ—Å—Ç–∏!",
                "dice": {
                    "difficulty": 7,
                    "success": "reactor_success",
                    "fail": "reactor_fail"
                }
            },
            "reactor_success": {
                "text": "‚úÖ –£–°–ü–ï–•! –†–µ–∞–∫—Ç–æ—Ä –ø–æ—á–∏–Ω–µ–Ω. –ö–æ—Ä–∞–±–ª—å —Å–ø–∞—Å—ë–Ω! (+1000‚Ç°)",
                "choices": [
                    {
                        "text": "üéâ –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É",
                        "next": "start",
                        "money": 1000,
                        "collect": {
                            "id": "state_reactor_fixed",
                            "label": "",
                            "type": "state"
                        }
                    }
                ]
            },
            "reactor_fail": {
                "text": "‚ùå –ü–†–û–í–ê–õ! –†–µ–∞–∫—Ç–æ—Ä –ø–æ–≤—Ä–µ–∂–¥—ë–Ω –µ—â—ë —Å–∏–ª—å–Ω–µ–µ (-50 HP).",
                "choices": [
                    {
                        "text": "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞",
                        "next": "engineering",
                        "health": -50
                    }
                ]
            },
            "crew_quarters": {
                "text": "–ö–∞—é—Ç—ã –ø—É—Å—Ç—ã. –ù–∞ —Å—Ç–æ–ª–µ 100 –∫—Ä–µ–¥–∏—Ç–æ–≤.",
                "choices": [
                    {
                        "text": "–í–∑—è—Ç—å –∫—Ä–µ–¥–∏—Ç—ã (+100‚Ç°)",
                        "next": "start",
                        "money": 100
                    }
                ]
            }
        };

        // ============= –ú–ê–ì–ê–ó–ò–ù =============
        const shopItems = [
            {
                id: "item_medkit",
                name: "üíä –ú–µ–¥–ø–∞–∫",
                price: 50,
                description: "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 50 HP"
            },
            {
                id: "item_energy_drink",
                name: "‚ö° –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫",
                price: 30,
                description: "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 30 —ç–Ω–µ—Ä–≥–∏–∏"
            },
            {
                id: "key_special_key",
                name: "üóùÔ∏è –û—Å–æ–±—ã–π –∫–ª—é—á",
                price: 200,
                description: "–û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–≤–µ—Ä–∏"
            },
            {
                id: "item_repair_kit",
                name: "üîß –†–µ–º–∫–æ–º–ø–ª–µ–∫—Ç",
                price: 150,
                description: "–î–ª—è —Ä–µ–º–æ–Ω—Ç–∞ —Å–∏—Å—Ç–µ–º"
            }
        ];

        // ============= –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ =============
        let playerStats = {
            health: 100,
            maxHealth: 100,
            stamina: 100,
            maxStamina: 100,
            money: 100
        };

        let currentNodeId = "start";
        let collectedItems = {}; // { "item_medkit": 3, "key_keycard": 1 }
        let currentPasswordNode = null;
        let currentDiceNode = null;

        // ============= –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ï–î–ú–ï–¢–ê–ú–ò =============

        function hasItem(itemId, quantity = 1) {
            return (collectedItems[itemId] || 0) >= quantity;
        }

        function addItem(itemId, quantity = 1) {
            if (!collectedItems[itemId]) {
                collectedItems[itemId] = 0;
            }
            collectedItems[itemId] += quantity;
        }

        function removeItem(itemId, quantity = 1) {
            if (collectedItems[itemId]) {
                collectedItems[itemId] -= quantity;
                if (collectedItems[itemId] <= 0) {
                    delete collectedItems[itemId];
                }
            }
        }

        function collectKey(keyData) {
            if (keyData && keyData.id) {
                const qty = keyData.quantity || 1;
                addItem(keyData.id, qty);
                saveGame();
                updateInventory();
                updateStats();

                if (keyData.label && keyData.label.trim() !== "") {
                    showKeyAnimation(keyData);
                }
            }
        }

        function consumeItem(consumeData) {
            if (consumeData && consumeData.id) {
                const qty = consumeData.quantity || 1;
                removeItem(consumeData.id, qty);
                saveGame();
                updateInventory();
            }
        }

        // ============= –°–¢–ê–¢–´ =============

        function modifyHealth(amount) {
            playerStats.health = Math.max(0, Math.min(playerStats.maxHealth, playerStats.health + amount));
            updateStats();

            if (playerStats.health === 0) {
                alert("üíÄ –í–´ –ü–û–ì–ò–ë–õ–ò!");
                resetGame();
            }
        }

        function modifyStamina(amount) {
            playerStats.stamina = Math.max(0, Math.min(playerStats.maxStamina, playerStats.stamina + amount));
            updateStats();
        }

        function modifyMoney(amount) {
            playerStats.money += amount;
            if (playerStats.money < 0) playerStats.money = 0;
            updateStats();
        }

        function updateStats() {
            document.getElementById('health-value').textContent = 
                `${playerStats.health}/${playerStats.maxHealth}`;
            document.getElementById('stamina-value').textContent = 
                `${playerStats.stamina}/${playerStats.maxStamina}`;
            document.getElementById('money-value').textContent = 
                playerStats.money;

            const healthPercent = (playerStats.health / playerStats.maxHealth) * 100;
            const staminaPercent = (playerStats.stamina / playerStats.maxStamina) * 100;

            document.getElementById('health-bar').style.width = healthPercent + '%';
            document.getElementById('stamina-bar').style.width = staminaPercent + '%';

            saveGame();
        }

        // ============= –ê–ù–ò–ú–ê–¶–ò–Ø =============

        function showKeyAnimation(keyData) {
            const targetList = getInventoryListForType(keyData.type || keyData.id.split('_')[0]);
            if (!targetList) return;

            const keyItem = document.createElement('div');
            keyItem.className = 'key-item key-animation';

            const qty = collectedItems[keyData.id] || 1;
            const label = document.createElement('span');
            label.textContent = keyData.label;
            keyItem.appendChild(label);

            if (qty > 1) {
                const qtyBadge = document.createElement('span');
                qtyBadge.className = 'item-quantity';
                qtyBadge.textContent = `x${qty}`;
                keyItem.appendChild(qtyBadge);
            }

            const prefix = keyData.id.split('_')[0];
            keyItem.classList.add(`${prefix}-type`);

            targetList.appendChild(keyItem);

            setTimeout(() => {
                keyItem.classList.remove('key-animation');
            }, 500);
        }

        function getInventoryListForType(type) {
            switch(type) {
                case 'quest': return document.getElementById('quests-list');
                case 'item': return document.getElementById('items-list');
                case 'key': return document.getElementById('keys-list');
                default: return document.getElementById('items-list');
            }
        }

        function updateInventory() {
            document.getElementById('quests-list').innerHTML = '';
            document.getElementById('items-list').innerHTML = '';
            document.getElementById('keys-list').innerHTML = '';

            let hasAnyItems = false;

            for (let itemId in collectedItems) {
                const qty = collectedItems[itemId];
                if (qty <= 0) continue;

                const keyData = findKeyData(itemId);
                if (!keyData || !keyData.label || keyData.label.trim() === "") continue;

                hasAnyItems = true;
                const prefix = itemId.split('_')[0];
                const targetList = getInventoryListForType(keyData.type || prefix);

                if (!targetList) continue;

                const keyItem = document.createElement('div');
                keyItem.className = `key-item ${prefix}-type`;

                const label = document.createElement('span');
                label.textContent = keyData.label;
                keyItem.appendChild(label);

                if (qty > 1) {
                    const qtyBadge = document.createElement('span');
                    qtyBadge.className = 'item-quantity';
                    qtyBadge.textContent = `x${qty}`;
                    keyItem.appendChild(qtyBadge);
                }

                targetList.appendChild(keyItem);
            }

            if (!document.getElementById('quests-list').children.length) {
                document.getElementById('quests-list').innerHTML = '<p style="color: #666; font-size: 0.85em;">–ù–µ—Ç –∫–≤–µ—Å—Ç–æ–≤</p>';
            }
            if (!document.getElementById('items-list').children.length) {
                document.getElementById('items-list').innerHTML = '<p style="color: #666; font-size: 0.85em;">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>';
            }
            if (!document.getElementById('keys-list').children.length) {
                document.getElementById('keys-list').innerHTML = '<p style="color: #666; font-size: 0.85em;">–ù–µ—Ç –∫–ª—é—á–µ–π</p>';
            }
        }

        function findKeyData(keyId) {
            for (let nodeId in story) {
                const node = story[nodeId];
                if (node.choices) {
                    for (let choice of node.choices) {
                        if (choice.collect && choice.collect.id === keyId) {
                            return choice.collect;
                        }
                    }
                }
            }
            return null;
        }

        // ============= –ü–†–û–í–ï–†–ö–ê –¢–†–ï–ë–û–í–ê–ù–ò–ô =============

        function checkRequirements(requires) {
            if (!requires || requires.length === 0) return true;
            return requires.every(keyId => hasItem(keyId, 1));
        }

        function getMissingKeyMessages(requires, missingMessages = {}) {
            if (!requires || requires.length === 0) return [];

            const missing = [];
            requires.forEach(keyId => {
                if (!hasItem(keyId, 1)) {
                    const message = missingMessages[keyId] || `‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è: ${keyId}`;
                    missing.push(message);
                }
            });
            return missing;
        }

        // ============= –†–ï–ù–î–ï–†–ò–ù–ì –£–ó–õ–ê =============

        function renderNode(nodeId) {
            const node = story[nodeId];
            if (!node) {
                document.getElementById('story-text').textContent = "‚ùå –£–∑–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: " + nodeId;
                return;
            }

            currentNodeId = nodeId;
            document.getElementById('story-text').textContent = node.text;

            const choicesContainer = document.getElementById('choices');
            choicesContainer.innerHTML = '';

            if (node.password) {
                currentPasswordNode = node;
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = 'üîê –í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å';
                button.onclick = () => openPasswordModal();
                choicesContainer.appendChild(button);
                return;
            }

            if (node.dice) {
                currentDiceNode = node;
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = 'üé≤ –ë—Ä–æ—Å–∏—Ç—å –∫–æ—Å—Ç–∏';
                button.onclick = () => openDiceModal();
                choicesContainer.appendChild(button);
                return;
            }

            if (node.choices) {
                node.choices.forEach((choice, index) => {
                    const button = document.createElement('button');
                    button.className = 'choice-button';
                    button.textContent = choice.text;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
                    if (choice.cost) {
                        const costSpan = document.createElement('span');
                        costSpan.className = 'choice-cost';
                        costSpan.textContent = `-${choice.cost}‚Ç°`;
                        button.appendChild(costSpan);
                    }

                    const requirementsMet = checkRequirements(choice.requires);
                    const hideUntilUnlocked = choice.hide_until_unlocked !== undefined ? choice.hide_until_unlocked : false;

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
                    const canAfford = !choice.cost || playerStats.money >= choice.cost;

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–º–∏–Ω—ã
                    const hasStamina = !choice.stamina || (choice.stamina > 0 || playerStats.stamina >= Math.abs(choice.stamina));

                    if (choice.requires && choice.requires.length > 0) {
                        if (!requirementsMet) {
                            if (hideUntilUnlocked === true) {
                                button.classList.add('choice-hidden');
                            } else {
                                button.disabled = true;
                                button.onclick = () => {
                                    const messages = getMissingKeyMessages(choice.requires, choice.missing_messages);
                                    if (messages.length > 0) {
                                        alert("–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ:\n" + messages.join("\n"));
                                    }
                                };
                            }
                        } else if (!canAfford) {
                            button.disabled = true;
                            button.onclick = () => alert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤!");
                        } else if (!hasStamina) {
                            button.disabled = true;
                            button.onclick = () => alert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏!");
                        } else {
                            button.onclick = () => handleChoice(choice, index);
                        }
                    } else {
                        if (!canAfford) {
                            button.disabled = true;
                            button.onclick = () => alert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤!");
                        } else if (!hasStamina) {
                            button.disabled = true;
                            button.onclick = () => alert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏!");
                        } else {
                            button.onclick = () => handleChoice(choice, index);
                        }
                    }

                    choicesContainer.appendChild(button);
                });
            }
        }

        function handleChoice(choice, choiceIndex) {
            // –î–µ–π—Å—Ç–≤–∏—è
            if (choice.action === 'open_shop') {
                openShop();
                return;
            }

            // –°—Ç–æ–∏–º–æ—Å—Ç—å
            if (choice.cost) {
                modifyMoney(-choice.cost);
            }

            // –î–µ–Ω—å–≥–∏
            if (choice.money) {
                modifyMoney(choice.money);
            }

            // –ó–¥–æ—Ä–æ–≤—å–µ
            if (choice.health) {
                modifyHealth(choice.health);
            }

            // –≠–Ω–µ—Ä–≥–∏—è
            if (choice.stamina) {
                modifyStamina(choice.stamina);
            }

            // –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            if (choice.consume) {
                consumeItem(choice.consume);
            }

            // –°–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            if (choice.collect) {
                collectKey(choice.collect);
            }

            // –ü–µ—Ä–µ—Ö–æ–¥
            if (choice.next) {
                renderNode(choice.next);
            }
        }

        // ============= –ü–ê–†–û–õ–¨ =============

        function openPasswordModal() {
            document.getElementById('password-modal').style.display = 'flex';
            document.getElementById('password-input').value = '';
            document.getElementById('password-input').focus();
        }

        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
        }

        function submitPassword() {
            const input = document.getElementById('password-input').value;
            const correct = currentPasswordNode.password.correct;

            closePasswordModal();

            if (input === correct) {
                renderNode(currentPasswordNode.password.success);
            } else {
                renderNode(currentPasswordNode.password.fail);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('password-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitPassword();
                }
            });
        });

        // ============= –ö–û–°–¢–ò =============

        function openDiceModal() {
            document.getElementById('dice-modal').style.display = 'flex';
            document.getElementById('dice1').textContent = '?';
            document.getElementById('dice2').textContent = '?';
            document.getElementById('dice-result').textContent = '';
            document.getElementById('dice-continue-btn').style.display = 'none';
        }

        function rollDice() {
            const dice1 = Math.floor(Math.random() * 6) + 1;
            const dice2 = Math.floor(Math.random() * 6) + 1;
            const total = dice1 + dice2;

            document.getElementById('dice1').textContent = dice1;
            document.getElementById('dice2').textContent = dice2;

            const difficulty = currentDiceNode.dice.difficulty;
            const success = total >= difficulty;

            const resultText = success 
                ? `‚úÖ –£—Å–ø–µ—Ö! (${total} >= ${difficulty})`
                : `‚ùå –ü—Ä–æ–≤–∞–ª! (${total} < ${difficulty})`;

            document.getElementById('dice-result').textContent = resultText;
            document.getElementById('dice-continue-btn').style.display = 'block';
            document.getElementById('dice-continue-btn').dataset.result = success ? 'success' : 'fail';
        }

        function continueDiceStory() {
            const success = document.getElementById('dice-continue-btn').dataset.result === 'success';
            document.getElementById('dice-modal').style.display = 'none';

            const nextNode = success 
                ? currentDiceNode.dice.success 
                : currentDiceNode.dice.fail;

            renderNode(nextNode);
        }

        // ============= –ö–ê–†–¢–ê =============

        document.getElementById('map-button').onclick = () => {
            document.getElementById('map-modal').style.display = 'flex';
            updateMap();
        };

        function closeMap() {
            document.getElementById('map-modal').style.display = 'none';
        }

        function updateMap() {
            const mapContainer = document.getElementById('map-locations');
            mapContainer.innerHTML = '';

            const locations = [
                { name: "üöÄ –ö–∞–ø—Å—É–ª–∞", id: "start" },
                { name: "üè• –ú–µ–¥–±–∞–π", id: "medbay" },
                { name: "üåâ –ú–æ—Å—Ç–∏–∫", id: "bridge" },
                { name: "‚öôÔ∏è –ò–Ω–∂–µ–Ω–µ—Ä–∏—è", id: "engineering", requires: ["key_keycard"] }
            ];

            locations.forEach(loc => {
                const div = document.createElement('div');
                div.style.padding = '10px';
                div.style.margin = '5px 0';
                div.style.background = 'rgba(0,255,255,0.1)';
                div.style.borderRadius = '5px';
                div.style.cursor = 'pointer';

                const canAccess = !loc.requires || checkRequirements(loc.requires);

                if (!canAccess) {
                    div.style.opacity = '0.5';
                    div.style.cursor = 'not-allowed';
                }

                div.textContent = loc.name + (canAccess ? '' : ' üîí');

                if (canAccess) {
                    div.onclick = () => {
                        closeMap();
                        renderNode(loc.id);
                    };
                }

                mapContainer.appendChild(div);
            });
        }

        // ============= –ú–ê–ì–ê–ó–ò–ù =============

        document.getElementById('shop-button').onclick = openShop;

        function openShop() {
            document.getElementById('shop-modal').style.display = 'flex';
            document.getElementById('shop-money').textContent = playerStats.money;

            const shopContainer = document.getElementById('shop-items');
            shopContainer.innerHTML = '';

            shopItems.forEach(item => {
                const shopItem = document.createElement('div');
                shopItem.className = 'shop-item';

                const info = document.createElement('div');
                info.className = 'shop-item-info';

                const name = document.createElement('div');
                name.className = 'shop-item-name';
                name.textContent = item.name;

                const desc = document.createElement('div');
                desc.style.color = '#888';
                desc.style.fontSize = '0.85em';
                desc.textContent = item.description;

                const price = document.createElement('div');
                price.className = 'shop-item-price';
                price.textContent = `üí∞ ${item.price} –∫—Ä–µ–¥–∏—Ç–æ–≤`;

                info.appendChild(name);
                info.appendChild(desc);
                info.appendChild(price);

                const buyBtn = document.createElement('button');
                buyBtn.className = 'shop-buy-btn';
                buyBtn.textContent = '–ö—É–ø–∏—Ç—å';
                buyBtn.onclick = () => buyItem(item);

                if (playerStats.money < item.price) {
                    buyBtn.disabled = true;
                }

                shopItem.appendChild(info);
                shopItem.appendChild(buyBtn);
                shopContainer.appendChild(shopItem);
            });
        }

        function buyItem(item) {
            if (playerStats.money >= item.price) {
                modifyMoney(-item.price);
                addItem(item.id, 1);

                const keyData = {
                    id: item.id,
                    label: item.name,
                    type: item.id.split('_')[0],
                    quantity: 1
                };

                updateInventory();
                showKeyAnimation(keyData);

                alert(`‚úÖ –ö—É–ø–ª–µ–Ω–æ: ${item.name}`);
                openShop(); // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–≥–∞–∑–∏–Ω
            } else {
                alert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤!");
            }
        }

        function closeShop() {
            document.getElementById('shop-modal').style.display = 'none';
        }

        // ============= –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê =============

        function saveGame() {
            const gameState = {
                currentNodeId: currentNodeId,
                collectedItems: collectedItems,
                playerStats: playerStats
            };
            localStorage.setItem('rpgGameSave', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('rpgGameSave');
            if (saved) {
                const gameState = JSON.parse(saved);
                currentNodeId = gameState.currentNodeId || 'start';
                collectedItems = gameState.collectedItems || {};
                playerStats = gameState.playerStats || {
                    health: 100,
                    maxHealth: 100,
                    stamina: 100,
                    maxStamina: 100,
                    money: 100
                };
            }
        }

        function resetGame() {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) {
                localStorage.removeItem('rpgGameSave');
                collectedItems = {};
                currentNodeId = 'start';
                playerStats = {
                    health: 100,
                    maxHealth: 100,
                    stamina: 100,
                    maxStamina: 100,
                    money: 100
                };
                updateInventory();
                updateStats();
                renderNode('start');
            }
        }

        // ============= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =============

        window.onload = () => {
            loadGame();
            updateInventory();
            updateStats();
            renderNode(currentNodeId);
        };

        window.addEventListener('beforeunload', saveGame);

    </script>
</body>
</html>
