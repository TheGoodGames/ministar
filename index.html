<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lin: Drake Clipper</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0c0c14;
      --fg: #e0e0ff;
      --accent: #5e7ce0;
      --deadend: #c0392b;
      --success: #27ae60;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: 'Segoe UI', Tahoma, sans-serif;
      padding: 20px;
      min-height: 100vh;
      overflow-x: hidden;
    }
    #app {
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
    }
    #scene {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }
    #scene.active {
      opacity: 1;
      transform: translateY(0);
    }
    .planet-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 12px;
      margin: 16px 0;
      background: #1a1a2e;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-style: italic;
    }
    .text {
      font-size: 18px;
      line-height: 1.5;
      margin: 20px 0;
      text-align: left;
    }
    .choices {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }
    .choice-btn {
      padding: 14px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      text-align: left;
    }
    .choice-btn:hover {
      background: #4a66d0;
    }
    .choice-btn:active {
      transform: scale(0.98);
    }
    .deadend .choice-btn {
      background: var(--deadend);
    }
    .deadend .choice-btn:hover {
      background: #a0281a;
    }
    .ending-success {
      color: var(--success);
      font-weight: bold;
    }
    .ending-fail {
      color: var(--deadend);
    }
    .loading {
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="scene" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</div>
  </div>

  <script>
    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
    let gameData = null;
    let currentState = null;
    const sceneEl = document.getElementById('scene');

    // === –ó–ê–ì–†–£–ó–ö–ê –ò–ì–†–û–í–´–• –î–ê–ù–ù–´–• ===
    async function loadGameData() {
      try {
        const res = await fetch('game_data.json');
        if (!res.ok) throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
        gameData = await res.json();
        startGame();
      } catch (e) {
        sceneEl.innerHTML = `<div class="text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}<br>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ game_data.json –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å index.html.</div>`;
      }
    }

    // === –ù–ê–ß–ê–õ–û –ò–ì–†–´ ===
    function startGame() {
      // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–µ—Ä–≤–æ–º—É —à–∞–≥—É (–±–µ–∑ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ ‚Äî Mini App –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–≤–æ–¥)
      showNode('m1');
    }

    // === –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –£–ó–õ–ê ===
    function showNode(nodeId) {
      if (!gameData || !gameData[nodeId]) {
        sceneEl.innerHTML = `<div class="text">–û—à–∏–±–∫–∞: —É–∑–µ–ª ${nodeId} –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>`;
        return;
      }

      const node = gameData[nodeId];
      currentState = nodeId;

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å—Ü–µ–Ω—ã
      const isEnding = node.ending === "true";
      const isDeadend = node.ending === "false";
      const className = isEnding ? 'ending-success' : isDeadend ? 'deadend ending-fail' : '';

      // –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è (–∑–∞–≥–ª—É—à–∫–∞ ‚Äî –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ URL)
      const imgSrc = getPlanetImage(nodeId);

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
      const choicesHtml = node.choices?.length
        ? node.choices.map(c => 
            `<button class="choice-btn" onclick="handleChoice('${c.next}')">${c.text}</button>`
          ).join('')
        : '';

      // –ê–Ω–∏–º–∞—Ü–∏—è: —Å–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã—Ç—å, –ø–æ—Ç–æ–º –ø–æ–∫–∞–∑–∞—Ç—å
      sceneEl.classList.remove('active');
      setTimeout(() => {
        sceneEl.className = `scene ${className}`;
        sceneEl.innerHTML = `
          ${imgSrc ? `<div class="planet-img">${imgSrc}</div>` : ''}
          <div class="text">${node.text}</div>
          <div class="choices">${choicesHtml}</div>
        `;
        sceneEl.classList.add('active');
      }, 300);
    }

    // === –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê ===
    window.handleChoice = function(nextId) {
      if (nextId === 'end_game') {
        Telegram.WebApp.sendData(JSON.stringify({ result: 'aborted' }));
        Telegram.WebApp.close();
        return;
      }

      if (nextId === 'restart_no_code') {
        return showNode('m1');
      }

      showNode(nextId);

      // –ï—Å–ª–∏ —ç—Ç–æ –∫–æ–Ω–µ—Ü ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      if (gameData[nextId]?.ending === "true") {
        Telegram.WebApp.sendData(JSON.stringify({ result: 'success' }));
        Telegram.WebApp.showAlert("–ü–æ–±–µ–¥–∞! DRAKE CLIPPER –Ω–∞–π–¥–µ–Ω.");
      } else if (gameData[nextId]?.ending === "false") {
        Telegram.WebApp.sendData(JSON.stringify({ result: 'deadend' }));
      }
    };

    // === –ü–û–î–ë–û–† –ò–õ–õ–Æ–°–¢–†–ê–¶–ò–ò ===
    function getPlanetImage(nodeId) {
      // –ú–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å CDN
      // –ü–æ–∫–∞ ‚Äî —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∑–∞–≥–ª—É—à–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø–ª–∞–Ω–µ—Ç—ã
      const planets = {
        'm1': 'Delamar', 'm2': 'ArcCorp', 'm3': 'Pyro',
        'm4': 'MicroTech', 'm5': 'Hurston'
      };
      const base = parseInt(nodeId.replace('m', '').split('_')[0]);
      const planet = planets[`m${((base - 1) % 5) + 1}`] || 'Unknown';
      return `<span>üåå ${planet}</span>`;
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    Telegram.WebApp.MainButton.setText('–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ');
    Telegram.WebApp.MainButton.show();
    Telegram.WebApp.MainButton.onClick(() => showNode('m1'));

    loadGameData();
  </script>
</body>
</html>
