<!DOCTYPE html>
<html lang="ru">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Lin: Drake Clipper</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&display=swap" rel="stylesheet">

<style>
/* ======= ТВОИ СТИЛИ (БЕЗ ИЗМЕНЕНИЙ) ======= */
:root {
    --bg: #0c0b14;
    --fg: #e8e6f6;
    --accent: #6a5acd;
    --success: #4caf50;
    --deadend: #f44336;
}

* { margin:0; padding:0; box-sizing:border-box }

body {
    background: var(--bg);
    color: var(--fg);
    font-family: 'Merriweather', serif;
    font-size: 19px;
    padding: 20px;
    min-height: 100vh;
}

/* ======= DICE 3D ======= */

#dice-screen {
    display: none;
    text-align: center;
    padding: 40px;
}

.dice-area {
    display: flex;
    justify-content: center;
    gap: 40px;
    perspective: 800px;
    margin-bottom: 30px;
}

.dice3d {
    width: 80px;
    height: 80px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 1s ease;
}

.dice3d.rolling {
    animation: rolling 1.2s linear infinite;
}

@keyframes rolling {
    50% { transform: rotateX(455deg) rotateY(455deg); }
}

.face {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 14px;
    border: 4px solid #ddd;
    background: linear-gradient(145deg,#dddbd8,#fff);
}

.face::after {
    content:'';
    position:absolute;
    top:50%; left:50%;
    width:14px; height:14px;
    background:#111;
    border-radius:50%;
    transform:translate(-50%,-50%);
}

.front { transform: translateZ(40px); }
.back { transform: rotateX(180deg) translateZ(40px); }
.top { transform: rotateX(90deg) translateZ(40px); }
.bottom { transform: rotateX(-90deg) translateZ(40px); }
.right { transform: rotateY(90deg) translateZ(40px); }
.left { transform: rotateY(-90deg) translateZ(40px); }

.front::after { width:20px; height:20px; background:#f44336 }
.back::after { box-shadow:24px 0,0 24px,24px 24px,0 48px,24px 48px }
.top::after { box-shadow:24px 24px }
.bottom::after { box-shadow:18px 18px,36px 36px,36px 0,0 36px }
.right::after { box-shadow:24px 0,0 24px,24px 24px }
.left::after { box-shadow:18px 18px,36px 36px }
</style>
</head>

<body>

<div id="app">
    <div id="scene" class="loading">Загрузка вселенной…</div>
</div>

<div id="dice-screen"></div>

<script>
/* ======= ТВОЙ JS (С СОХРАНЁННОЙ ЛОГИКОЙ) ======= */

let story = null;
let currentNodeId = null;
let diceAnimationInterval = null;

const sceneEl = document.getElementById('scene');
const diceScreen = document.getElementById('dice-screen');

/* ===== helpers ===== */

function diceFaces() {
    return `
        <div class="face front"></div>
        <div class="face back"></div>
        <div class="face top"></div>
        <div class="face bottom"></div>
        <div class="face right"></div>
        <div class="face left"></div>`;
}

function setDiceValue(el, v) {
    const map = {
        1:'rotateX(0deg) rotateY(0deg)',
        2:'rotateX(-90deg) rotateY(0deg)',
        3:'rotateX(0deg) rotateY(90deg)',
        4:'rotateX(0deg) rotateY(-90deg)',
        5:'rotateX(90deg) rotateY(0deg)',
        6:'rotateX(180deg) rotateY(0deg)'
    };
    el.style.transform = map[v];
}

/* ===== DICE ===== */

function rollDice(successTarget, partialTarget, failTarget) {

    sceneEl.style.display = 'none';
    diceScreen.style.display = 'block';

    diceScreen.innerHTML = `
        <div class="dice-area">
            <div class="dice3d" id="dice1">${diceFaces()}</div>
            <div class="dice3d" id="dice2">${diceFaces()}</div>
        </div>
        <div class="result">Бросок…</div>
        <button class="choice-btn" id="roll-button">Бросить</button>
    `;

    document.getElementById('roll-button').onclick = () => {

        const d1 = Math.floor(Math.random()*6)+1;
        const d2 = Math.floor(Math.random()*6)+1;

        const dice1 = document.getElementById('dice1');
        const dice2 = document.getElementById('dice2');

        dice1.classList.add('rolling');
        dice2.classList.add('rolling');

        setTimeout(() => {
            dice1.classList.remove('rolling');
            dice2.classList.remove('rolling');

            setDiceValue(dice1,d1);
            setDiceValue(dice2,d2);

            const total = d1+d2;

            diceScreen.innerHTML += `
                <div class="result">Выпало: <strong>${total}</strong></div>
                <button class="choice-btn" onclick="proceedAfterDice(${total})">Продолжить</button>
            `;

            window.proceedAfterDice = function(total){
                diceScreen.style.display='none';
                sceneEl.style.display='block';

                let target = total>=8 ? successTarget : (total===7 ? partialTarget : failTarget);
                if (target && story[target]) showNode(target);
                else showNode("0");
            };
        },1200);
    };
}

/* ===== LOAD STORY ===== */

async function loadStory() {
    const res = await fetch('story.json');
    story = await res.json();
    showNode("0");
}

function showNode(id) {
    const node = story[id];
    if (!node) return;
    sceneEl.innerHTML = `<p>${node.text}</p>` +
        (node.choices||[]).map(c =>
            `<button onclick="handleChoice('${c.next}')">${c.text}</button>`
        ).join('');
}

function handleChoice(next) {
    if (next.startsWith("DICE:")) {
        const p = next.slice(5).split(',');
        rollDice(p[0],p[1],p[2]);
        return;
    }
    showNode(next);
}

document.addEventListener('DOMContentLoaded', loadStory);
</script>

</body>
</html>
